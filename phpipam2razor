#!/usr/bin/env php
<?php
// -----------------------------------------------------------------------------
// Usage: $ ./phpipam2razor <subnet>
//
// Example:
//        $ ./phpipam2razor 147.251.90.0/24 > nodes
// -----------------------------------------------------------------------------

printf("\n");

// subnet is the first argument
if( count($argv) != 2 ){
    printf(">>> ERROR: Subnet not specified!\n\n");
    exit(1);
}

$subnet = $argv[1];
if( $subnet == "" ) {
    printf(">>> ERROR: Subnet not specified!\n\n");
    exit(1);
}

// access to phpIPAM api
include 'phpipam.conf';

// -----------------------------------------------------------------------------

require_once(__DIR__ . '/extras/lib.php');

// -----------------------------------------------------------------------------

function generate_header()
{
    global $url, $subnet_data, $subnet, $vlan_data;

    // THERE MUST BE AN EMPTY SPACE BEFORE A COMMENT (#)
    
    printf("  # -----------------------------------------------------------------------------\n");
    printf("  # GENERATED BY phpipam2razor - DO NOT EDIT\n");
    printf("  # -----------------------------------------------------------------------------\n"); 
    printf("  # data source: %s\n",$url);    
    printf("  # date       : %s\n",date("Y-m-d H:i:s"));  
    printf("  # admin      : %s\n",$subnet_data->data->custom_Admin);
    printf("  # -----------------------------------------------------------------------------\n");    
    printf("\n");
    printf("  # subnet: %s\n",$subnet);
    printf("  # vlan  : %d (%s)\n",$vlan_data->data->number, $vlan_data->data->name);
    printf("  # -----------------------------------------------------------------------------\n");      
}

// -----------------------------------------------------------------------------

function generate_group()
{
    global $hosts;
        
    foreach($hosts->data as $item){
        if( ( $item->ip == "" ) || ( $item->hostname == "" ) || ( $item->mac == "" ) || ( $item->custom_Razor == "" ) ) continue;
        printf("\n");        
        printf("  # --\n");
        printf("  # Admin     : %s\n",$item->custom_Admin);
        if( $item->custom_User != "" ){
        printf("  # User      : %s\n",$item->custom_User); 
        }
        printf("  # Group     : %s\n",$item->custom_Group);
        if( $item->custom_Cluster != "" ){        
        printf("  # Cluster   : %s\n",$item->custom_Cluster);
        }
        if( $item->location > 0 ){
        printf("  # Location  : %s\n",get_location_name($item->location));
        }
        if( $item->port != "" ){
        printf("  # Plug/port : %s\n",$item->port);
        }        
        printf("%s %s %s\n",$item->hostname,$item->mac,$item->custom_Razor);
    }

    printf("\n");
    
}

// -----------------------------------------------------------------------------

init_session();
get_subnetid();
get_subnet();
get_vlan();
get_hosts();
generate_header();
generate_group();

?>
