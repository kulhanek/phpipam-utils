#!/usr/bin/env php
<?php
// -----------------------------------------------------------------------------
// Usage: $ ./phpipam2ports <device>
//
// Example:
//        $ ./phpipam2 2S027SW2A
//
// Output file:
//        2S027SW2A.ports
// -----------------------------------------------------------------------------

printf("\n");

if( $argc < 2 ){
    printf(">>> ERROR: No device name specified!\n\n");
    exit(1);
} 

$devname = $argv[1];
if( $devname == "" ) {
    printf(">>> ERROR: No device name specified!\n\n");
    exit(1);
}

printf("Device name: %s\n",$devname);

// access to phpIPAM api
include 'phpipam.conf';

// -----------------------------------------------------------------------------

require_once(__DIR__ . '/extras/lib.php');

// -----------------------------------------------------------------------------

function generate_header($fh)
{
    global $device,$url;

    fprintf($fh,"# -----------------------------------------------------------------------------\n");
    fprintf($fh,"# GENERATED BY phpipam2ports - DO NOT EDIT\n");
    fprintf($fh,"# -----------------------------------------------------------------------------\n");
    fprintf($fh,"# data source: %s\n",$url);
    fprintf($fh,"# date       : %s\n",date("Y-m-d H:i:s"));
    fprintf($fh,"\n");
    fprintf($fh,"# device name: %s\n",$device->hostname);
    fprintf($fh,"# description: %s\n",str_replace("\r",'',str_replace("\n", ' ', $device->description)));
    fprintf($fh,"# location:    %s\n",get_location_name($device->location));

    fprintf($fh,"\n");
    fprintf($fh,"# Port      VLAN  Description\n");
    fprintf($fh,"# -------- ------ -------------------------------------------------------------\n");
}

// -----------------------------------------------------------------------------

function generate_ports($fh)
{
    global $hosts, $subnet_data, $vlan_data;

    foreach($hosts->data as $host){
        if( $host->port == "" ) continue;
        get_subnet($host->subnetId);
        if( $subnet_data->data->vlanId == 0 ) continue;
        get_vlan($subnet_data->data->vlanId);        
        $desc = sprintf("%s, Group: %s",$host->hostname,$host->custom_Group);
        fprintf($fh,"%-10s %-6d %s\n",$host->port,$vlan_data->data->number,$desc);
    }
}

// -----------------------------------------------------------------------------

init_session();
get_devices();

$device = "";

// find device
foreach($devices->data as $item){
    if( $item->hostname == $devname ){
        $device = $item;
        break;
    }
}

if( $device == "" ){
    printf("\n>>> ERROR: Unable to locate device %s!\n\n",$devname);
    exit(1);
}

$devname_conf = sprintf("%s.ports",$devname);

printf("\n");
printf("Generating port configuration: %s\n",$devname_conf);
$fh = fopen($devname_conf,"w");
if( $fh == false ){
    printf(">>> ERROR: Unable to open %s for writing!\n\n",$devname_conf);
    exit(1);
}

generate_header($fh);
get_hosts($device->id);
generate_ports($fh);
fclose($fh);

printf("Done!\n\n");

?>
